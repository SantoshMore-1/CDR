<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced CDR File Processor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --telecom-blue: #005eb8;
            --telecom-purple: #6a0dad;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--telecom-blue), var(--telecom-purple));
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, var(--telecom-blue), var(--primary));
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
            border-bottom: 5px solid var(--secondary);
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .logo i {
            font-size: 3rem;
            color: white;
            background: var(--secondary);
            border-radius: 50%;
            padding: 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 5px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 15px;
            font-weight: 300;
        }
        
        .upload-section {
            padding: 40px;
            background: var(--light);
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        
        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            max-width: 700px;
            margin: 0 auto;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 2px dashed var(--secondary);
        }
        
        .upload-icon {
            font-size: 5rem;
            color: var(--telecom-blue);
        }
        
        .upload-text {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 500;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(to right, var(--telecom-blue), var(--telecom-purple));
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            background: linear-gradient(to right, #004a99, #5d0b9d);
        }
        
        .file-name {
            margin-top: 15px;
            font-size: 1.1rem;
            color: #555;
            font-weight: 500;
            text-align: center;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .file-type {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .file-type-btn {
            padding: 12px 25px;
            background: #f1f1f1;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .file-type-btn.active {
            background: var(--telecom-blue);
            color: white;
            border-color: var(--telecom-blue);
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .table-section {
            padding: 30px;
            display: none;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        select {
            padding: 10px 15px;
            border: 2px solid var(--telecom-blue);
            border-radius: 8px;
            background: white;
            font-size: 1rem;
            font-weight: 500;
            min-width: 80px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: var(--telecom-blue);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: var(--accent);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .table-container {
            overflow-x: auto;
            border: 1px solid #eee;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            max-height: 600px;
            overflow-y: auto;
            position: relative;
            background: white;
            border: 2px solid var(--telecom-blue);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 2400px;
        }
        
        th, td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid #eee;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.95rem;
        }
        
        th {
            background: linear-gradient(to bottom, var(--telecom-blue), var(--primary));
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        
        th:last-child {
            border-right: none;
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        tr:hover {
            background-color: #e3f2fd;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .page-btn {
            padding: 10px 18px;
            background: white;
            border: 2px solid var(--telecom-blue);
            cursor: pointer;
            border-radius: 8px;
            min-width: 45px;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .page-btn:hover {
            background: var(--telecom-blue);
            color: white;
        }
        
        .page-btn.active {
            background: var(--telecom-blue);
            color: white;
            border-color: var(--telecom-blue);
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .page-nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .instructions {
            max-width: 900px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid var(--telecom-blue);
        }
        
        .instructions h2 {
            color: var(--telecom-blue);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
            border-bottom: 2px solid var(--telecom-blue);
            padding-bottom: 15px;
        }
        
        .steps {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-top: 25px;
        }
        
        .step {
            flex: 1;
            min-width: 250px;
            padding: 25px;
            background: linear-gradient(to bottom right, #f0f9ff, #e0f2fe);
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #bbdefb;
        }
        
        .step i {
            font-size: 3rem;
            color: var(--telecom-blue);
            margin-bottom: 20px;
            background: white;
            border-radius: 50%;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        .step h3 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.4rem;
        }
        
        .step p {
            font-size: 1.1rem;
            color: #444;
            line-height: 1.6;
        }
        
        footer {
            text-align: center;
            padding: 30px;
            background: linear-gradient(to right, var(--primary), var(--telecom-blue));
            color: white;
            margin-top: 30px;
            font-size: 1.1rem;
        }
        
        .status-bar {
            padding: 15px;
            text-align: center;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            font-weight: 600;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .column-count {
            background: white;
            color: var(--telecom-blue);
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .action-bar {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .info-card {
            background: linear-gradient(to bottom, #ffffff, #f5f9ff);
            border-radius: 15px;
            padding: 30px;
            margin: 30px auto;
            max-width: 900px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid #bbdefb;
        }
        
        .info-card h3 {
            color: var(--telecom-blue);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.7rem;
            border-bottom: 2px solid var(--telecom-blue);
            padding-bottom: 15px;
        }
        
        .info-card p {
            font-size: 1.15rem;
            color: #333;
            line-height: 1.7;
            margin-bottom: 20px;
        }
        
        .info-card ul {
            margin: 25px 0;
            padding-left: 30px;
        }
        
        .info-card li {
            font-size: 1.15rem;
            color: #333;
            line-height: 1.8;
            margin-bottom: 10px;
        }
        
        .highlight {
            background-color: #e3f2fd;
            padding: 3px 8px;
            border-radius: 5px;
            font-weight: 600;
            color: var(--telecom-blue);
        }
        
        .telecom-badge {
            display: inline-block;
            background: var(--telecom-blue);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: left;
        }
        
        .file-list-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .file-list-item:last-child {
            border-bottom: none;
        }
        
        .file-list-item i {
            margin-right: 10px;
            color: var(--telecom-blue);
        }
        
        .file-count-badge {
            background: var(--telecom-purple);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        @media (max-width: 1200px) {
            .upload-section {
                padding: 30px 20px;
            }
            
            .file-upload {
                padding: 30px;
            }
            
            .upload-icon {
                font-size: 4rem;
            }
            
            .upload-text {
                font-size: 1.2rem;
            }
            
            .upload-btn {
                padding: 12px 30px;
                font-size: 1.1rem;
            }
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .pagination-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .file-type {
                flex-direction: column;
            }
            
            th, td {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-satellite-dish"></i>
                <div>
                    <h1>Advanced CDR File Processor</h1>
                    <div class="subtitle">Process Multiple CDR Files & Folders</div>
                </div>
            </div>
        </header>
        
        <section class="upload-section">
            <div class="file-upload">
                <i class="fas fa-folder-open upload-icon"></i>
                <div class="upload-text">Upload CDR files or entire folders</div>
                
                <div style="display: flex; gap: 15px; margin-top: 10px;">
                    <input type="file" id="fileInput" class="file-input" accept=".txt,.csv" multiple>
                    <label for="fileInput" class="upload-btn">
                        <i class="fas fa-file-upload"></i> Select Files
                    </label>
                    
                    <input type="file" id="folderInput" class="file-input" webkitdirectory directory multiple>
                    <label for="folderInput" class="upload-btn">
                        <i class="fas fa-folder"></i> Select Folder
                    </label>
                </div>
                
                <div class="file-name" id="fileName">
                    <div id="fileCount">No files selected</div>
                    <div class="file-list" id="fileList"></div>
                </div>
                
                <div class="file-type">
                    <div class="file-type-btn active" id="cdrBtn">CDR File Format</div>
                    <div class="file-type-btn" id="textBtn">Raw Text Format</div>
                </div>
            </div>
        </section>
        
        <section class="info-card">
            <h3>Multi-File CDR Processing</h3>
            <p>This enhanced processor handles multiple CDR files simultaneously with:</p>
            <ul>
                <li><i class="fas fa-check-circle" style="color: #27ae60;"></i> <strong>Folder upload support</strong> - process entire directories of CDR files</li>
                <li><i class="fas fa-check-circle" style="color: #27ae60;"></i> <strong>Multi-file selection</strong> - select and process multiple files at once</li>
                <li><i class="fas fa-check-circle" style="color: #27ae60;"></i> <strong>Combined data view</strong> - view all records from multiple files in one table</li>
                <li><i class="fas fa-check-circle" style="color: #27ae60;"></i> <strong>File list display</strong> - see all processed files with status indicators</li>
                <li><i class="fas fa-check-circle" style="color: #27ae60;"></i> <strong>206-column support</strong> - handles the full CDR specification</li>
            </ul>
            
            <p>Upload multiple CDR files to analyze call patterns across different time periods or network segments.</p>
        </section>
        
        <section class="table-section" id="tableSection">
            <div class="status-bar" id="statusBar">
                <i class="fas fa-database"></i> 
                <span id="statusText">Ready to process CDR files</span>
                <span class="column-count" id="columnCount">0 files, 0 records</span>
            </div>
            
            <div class="controls">
                <div class="pagination-controls">
                    <div class="rows-per-page">
                        <span>Rows per page:</span>
                        <select id="rowsPerPage">
                            <option value="10">10</option>
                            <option value="30" selected>30</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    
                    <div class="page-nav">
                        <button class="btn btn-primary" id="firstPage" title="First Page">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="btn btn-primary" id="prevPage" title="Previous Page">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <span id="pageInfo" style="font-weight:600; min-width:120px; text-align:center;">Page 1 of 1</span>
                        <button class="btn btn-primary" id="nextPage" title="Next Page">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="btn btn-primary" id="lastPage" title="Last Page">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="action-bar">
                    <button class="btn btn-success" id="downloadBtn">
                        <i class="fas fa-file-csv"></i> Export to CSV
                    </button>
                    <button class="btn btn-danger" id="resetBtn">
                        <i class="fas fa-sync-alt"></i> Reset Processor
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="cdrTable">
                    <thead>
                        <tr id="tableHeader">
                            <!-- Table headers will be generated here -->
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Table rows will be generated here -->
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- Pagination buttons will be generated here -->
            </div>
        </section>
        
        <footer>
            <p>Advanced CDR File Processor &copy; 2023 | Telecom Data Analytics Solution</p>
        </footer>
    </div>

    <script>
        // CDR headers from your original file
        const cdrHeaders = [
            "Accounting Status", "NAS IP Address", "NAS Port", "Accounting Session ID", 
            "Ingress Session ID", "Egress Session ID", "Session Protocol Type", 
            "Session-Forked-Call-Id", "Generic ID", "Calling Station ID", 
            "Called Station ID", "Accounting Termination Cause<br>Is this Cause Code?", 
            "Accounting Session Time", "Cisco Setup Time", "Cisco Connect Time", 
            "Cisco Disconnect Time", "Cisco Disconnect Cause", 
            "Egress Network Interface ID", "Egress Vlan Tag Value", 
            "Ingress Network Interface ID", "Ingress Vlan Tag Value", 
            "Egress Realm", "Ingress Realm", "Flow Identifier", 
            "Flow Type<br>Is this Codec?", "Flow Input Realm", "Flow Input Src Addr", 
            "Flow Input Src Port", "Flow Input Dest Address", "Flow Input Dest Port", 
            "Flow Output Realm", "Flow Output Src Address", "Flow Output Src Port", 
            "Flow Output Dest Addr", "Flow Output Dest Port", 
            "RTCP Calling Packets Lost", "RTCP Calling Avg Jitter (msec)", 
            "RTCP Calling Avg Latency (msec)", "RTCP Calling Max Jitter (msec)", 
            "RTCP Calling Max Latency (msec)", "RTP Calling Packets Lost", 
            "RTP Calling Avg Jitter (msec)", "RTP Calling Max Jitter (msec)", 
            "RTP Calling Octets", "RTP Calling Packets", "Calling R-Factor", 
            "Calling MOS", "Flow Identifier", "Flow Type", "Flow Input Realm", 
            "Flow Input Src Addr", "Flow Input Src Port", "Flow Input Dest Address", 
            "Flow Input Dest Port", "Flow Output Realm", "Flow Output Src Address", 
            "Flow Output Src Port", "Flow Output Dest Addr", "Flow Output Dest Port", 
            "RTCP Called Packets Lost", "RTCP Called Avg Jitter (msec)", 
            "RTCP Called Avg Latency (msec)", "RTCP Called Max Jitter (msec)", 
            "RTCP Called Max Latency (msec)", "RTP Called Packets Lost", 
            "RTP Called Avg Jitter (msec)", "RTP Called Max Jitter (msec)", 
            "RTP Called Octets", "RTP Called Packets", "Called R-Factor", 
            "Called MOS", "Flow Identifier", "Flow Type", "Flow Input Realm", 
            "Flow Input Src Addr", "Flow Input Src Port", "Flow Input Dest Address", 
            "Flow Input Dest Port", "Flow Output Realm", "Flow Output Src Address", 
            "Flow Output Src Port", "Flow Output Dest Addr", "Flow Output Dest Port", 
            "RTCP Calling Packets Lost", "RTCP Calling Avg Jitter (msec)", 
            "RTCP Calling Avg Latency (msec)", "RTCP Calling Max Jitter (msec)", 
            "RTCP Calling Max Latency (msec)", "RTP Calling Packets Lost", 
            "RTP Calling Avg Jitter (msec)", "RTP Calling Max Jitter (msec)", 
            "RTP Calling Octets", "RTP Calling Packets", "Flow Identifier", 
            "Flow Type", "Flow Input Realm", "Flow Input Src Addr", 
            "Flow Input Src Port", "Flow Input Dest Address", "Flow Input Dest Port", 
            "Flow Output Realm", "Flow Output Src Address", "Flow Output Src Port", 
            "Flow Output Dest Addr", "Flow Output Dest Port", 
            "RTCP Called Packets Lost", "RTCP Called Avg Jitter (msec)", 
            "RTCP Called Avg Latency (msec)", "RTCP Called Max Jitter (msec)", 
            "RTCP Called Max Latency (msec)", "RTP Called Packets Lost", 
            "RTP Called Avg Jitter (msec)", "RTP Called Max Jitter (msec)", 
            "RTP Called Octets", "RTP Called Packets", "Charging Vector ICID", 
            "Charging Function Address", "Firmware Version", "Local timezone", 
            "Post Dial Delay (msec)", "Primary routing Number", 
            "Originating Trunk Group", "Terminating Trunk Group", 
            "Originating Trunk Context", "Terminating Trunk Context", "P Asserted ID", 
            "Ingress Local Address", "Ingress Remote Address", 
            "Egress Local Address", "Egress Remote Address", "SIP DIVERSION", 
            "Session Disposition", "Disconnect Initiator", "Disconnect Cause", 
            "Sip Status Code", "Egress Routing Number", "Ingress RPH", "Egress RPH", 
            "refer call transfer ID","Custom VSA 200","Custom VSA 201",
            "Custom VSA 202","Custom VSA 203","Custom VSA 204","Custom VSA 205",
            "Custom VSA 206","Custom VSA 207","Custom VSA 208","Custom VSA 209",
            "Custom VSA 210","Custom VSA 211","Custom VSA 212",
            "Custom VSA 213","Custom VSA 214","Custom VSA 215",
            "Custom VSA 216","Custom VSA 217","Custom VSA 218",
            "Custom VSA 219","Custom VSA 220","Custom VSA 221",
            "Custom VSA 222","Custom VSA 223","Custom VSA 224",
            "Custom VSA 225","Custom VSA 226","Custom VSA 227",
            "Custom VSA 228","Custom VSA 229","Custom VSA 230",
            "Calling-Media-Stop-Time"," Called-Media-Stop-Time",
            "Calling-Media-Stop-Time","Called-Media-Stop-Time",
            "Flow Media Type","Flow Media Type","Flow Media Type",
            "Flow Media Type","RTP Calling Octets Transmitted","RTP Calling Packets Transmitted",
            "RTP Called Octets Transmitted","RTP Called Packets Transmitted","RTP Calling Octets Transmitted","RTP Calling Packets Transmitted","RTP Calling Octets Transmitted",
            "RTP Calling Packets Transmitted","MSRP Called Octets","MSRP Called Packets","MSRP Called Octets Transmitted","MSRP Called Packets Transmitted","MSRP Calling Octets",
            "MSRP Calling Packets","MSRP Calling Octets Transmitted","MSRP Calling Packets Transmitted","PGW-IP Address","SGW-IP Address","ORIG-IOI","TERM-IOI",
            "IMEI","Node Functionality","History Info","P-Visited Network ID","IMSI","Access-Network-Information","CDR Sequence Number","Stir-Signed-Request","Stir-Signed-Request-Exception-Id",
            "Stir-Verified-Request","Stir-Verified-Request-Exception-Id","Stir-VS-Verstat","Stir-VS-Reason","Stir-TN-Used-For-AS-VS-Request","Stir-Div-Signed-Request","Stir-Div-Verified-Request",
            "History Info2","Stir-VS-Invite-State"
        ];
        
        // Global variables
        let currentData = [];
        let rowsPerPage = 30;
        let currentPage = 1;
        let totalPages = 1;
        let fileType = 'cdr';
        let files = [];
        
        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            const folderInput = document.getElementById('folderInput');
            const fileCount = document.getElementById('fileCount');
            const fileList = document.getElementById('fileList');
            const tableSection = document.getElementById('tableSection');
            const downloadBtn = document.getElementById('downloadBtn');
            const resetBtn = document.getElementById('resetBtn');
            const cdrBtn = document.getElementById('cdrBtn');
            const textBtn = document.getElementById('textBtn');
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            const columnCount = document.getElementById('columnCount');
            const rowsPerPageSelect = document.getElementById('rowsPerPage');
            const firstPageBtn = document.getElementById('firstPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const lastPageBtn = document.getElementById('lastPage');
            const pageInfo = document.getElementById('pageInfo');
            const pagination = document.getElementById('pagination');
            
            // Initialize status
            updateStatusBar();
            
            // Event listeners
            fileInput.addEventListener('change', handleFileUpload);
            folderInput.addEventListener('change', handleFolderUpload);
            cdrBtn.addEventListener('click', () => setFileType('cdr'));
            textBtn.addEventListener('click', () => setFileType('text'));
            downloadBtn.addEventListener('click', downloadCSV);
            resetBtn.addEventListener('click', resetApp);
            rowsPerPageSelect.addEventListener('change', changeRowsPerPage);
            firstPageBtn.addEventListener('click', goToFirstPage);
            prevPageBtn.addEventListener('click', goToPrevPage);
            nextPageBtn.addEventListener('click', goToNextPage);
            lastPageBtn.addEventListener('click', goToLastPage);
            
            // Set file type
            function setFileType(type) {
                fileType = type;
                cdrBtn.classList.toggle('active', type === 'cdr');
                textBtn.classList.toggle('active', type === 'text');
                
                if (files.length > 0) {
                    processFiles();
                }
            }
            
            // Handle file upload
            function handleFileUpload(e) {
                files = Array.from(e.target.files);
                updateFileList();
                processFiles();
            }
            
            // Handle folder upload
            function handleFolderUpload(e) {
                files = Array.from(e.target.files);
                updateFileList();
                processFiles();
            }
            
            // Update file list display
            function updateFileList() {
                if (files.length === 0) {
                    fileCount.textContent = "No files selected";
                    fileList.innerHTML = "";
                    return;
                }
                
                fileCount.textContent = `${files.length} file${files.length > 1 ? 's' : ''} selected`;
                fileList.innerHTML = "";
                
                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-list-item';
                    fileItem.innerHTML = `<i class="fas fa-file-alt"></i> ${file.name}`;
                    fileList.appendChild(fileItem);
                });
            }
            
            // Process all files
            async function processFiles() {
                if (files.length === 0) {
                    statusText.textContent = "No files to process";
                    return;
                }
                
                statusText.textContent = `Processing ${files.length} file${files.length > 1 ? 's' : ''}...`;
                statusBar.style.backgroundColor = '#f1c40f';
                statusBar.style.display = 'flex';
                
                try {
                    // Reset current data
                    currentData = [cdrHeaders];
                    let totalRecords = 0;
                    
                    for (const file of files) {
                        const content = await readFileAsync(file);
                        const rows = content.split('\n').filter(line => line.trim() !== '');
                        
                        for (let i = 0; i < rows.length; i++) {
                            const row = rows[i].split(',').map(cell => cell.trim());
                            
                            // For CDR files, skip header row after the first file
                            if (fileType === 'cdr' && i === 0 && currentData.length > 1) {
                                continue;
                            }
                            
                            if (row.length > 0) {
                                currentData.push(row);
                                totalRecords++;
                            }
                        }
                    }
                    
                    // Update status
                    statusText.textContent = `Processed ${files.length} file${files.length > 1 ? 's' : ''} successfully`;
                    statusBar.style.backgroundColor = '#27ae60';
                    tableSection.style.display = 'block';
                    
                    // Render table
                    renderTable();
                    updateStatusBar();
                    updatePageInfo();
                    
                    // Scroll to table section
                    setTimeout(() => {
                        tableSection.scrollIntoView({ behavior: 'smooth' });
                    }, 300);
                    
                } catch (error) {
                    console.error('Error processing files:', error);
                    statusText.textContent = "Error processing files: " + error.message;
                    statusBar.style.backgroundColor = '#e74c3c';
                }
            }
            
            // Helper function to read file as text
            function readFileAsync(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
            }
            
            // Render table with pagination
            function renderTable() {
                // Clear existing content
                tableHeader.innerHTML = '';
                tableBody.innerHTML = '';
                pagination.innerHTML = '';
                
                // Create headers
                if (currentData.length > 0 && currentData[0].length > 0) {
                    currentData[0].forEach(header => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        th.title = header;
                        tableHeader.appendChild(th);
                    });
                    
                    // Calculate total pages
                    totalPages = Math.ceil((currentData.length - 1) / rowsPerPage);
                    
                    // Create pagination buttons
                    if (totalPages > 1) {
                        const startPage = Math.max(1, currentPage - 2);
                        const endPage = Math.min(totalPages, startPage + 4);
                        
                        for (let i = startPage; i <= endPage; i++) {
                            const button = document.createElement('button');
                            button.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                            button.textContent = i;
                            button.addEventListener('click', () => {
                                currentPage = i;
                                renderTable();
                                updatePageInfo();
                            });
                            pagination.appendChild(button);
                        }
                    }
                    
                    // Create rows for current page
                    const startIndex = (currentPage - 1) * rowsPerPage + 1;
                    const endIndex = Math.min(startIndex + rowsPerPage, currentData.length);
                    
                    for (let i = startIndex; i < endIndex; i++) {
                        const row = document.createElement('tr');
                        
                        // Create data cells
                        currentData[i].forEach(cell => {
                            const td = document.createElement('td');
                            td.textContent = cell;
                            td.title = cell;
                            row.appendChild(td);
                        });
                        
                        tableBody.appendChild(row);
                    }
                }
                
                updatePageButtons();
            }
            
            // Change rows per page
            function changeRowsPerPage() {
                rowsPerPage = parseInt(rowsPerPageSelect.value);
                currentPage = 1;
                renderTable();
                updateStatusBar();
                updatePageInfo();
            }
            
            // Navigation functions
            function goToFirstPage() {
                currentPage = 1;
                renderTable();
                updatePageInfo();
            }
            
            function goToPrevPage() {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                    updatePageInfo();
                }
            }
            
            function goToNextPage() {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                    updatePageInfo();
                }
            }
            
            function goToLastPage() {
                currentPage = totalPages;
                renderTable();
                updatePageInfo();
            }
            
            // Update page buttons state
            function updatePageButtons() {
                firstPageBtn.disabled = currentPage === 1;
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
                lastPageBtn.disabled = currentPage === totalPages;
            }
            
            // Update page info display
            function updatePageInfo() {
                const startRecord = (currentPage - 1) * rowsPerPage + 1;
                const endRecord = Math.min(startRecord + rowsPerPage - 1, currentData.length - 1);
                const totalRecords = currentData.length - 1;
                pageInfo.textContent = `Page ${currentPage} of ${totalPages} | Records ${startRecord}-${endRecord} of ${totalRecords}`;
                updatePageButtons();
            }
            
            // Update status bar
            function updateStatusBar() {
                if (currentData.length > 1) {
                    const totalRecords = currentData.length - 1;
                    columnCount.textContent = `${files.length} files, ${totalRecords} records`;
                    statusBar.style.display = 'flex';
                } else {
                    columnCount.textContent = "No data loaded";
                }
            }
            
            // Download CSV
            function downloadCSV() {
                if (currentData.length < 2) {
                    statusText.textContent = "No data to export";
                    statusBar.style.backgroundColor = '#e74c3c';
                    setTimeout(() => {
                        statusBar.style.backgroundColor = '';
                    }, 3000);
                    return;
                }
                
                // Create CSV content
                let csvContent = '';
                
                // Headers
                csvContent += currentData[0].join(',') + '\n';
                
                // Data rows
                for (let i = 1; i < currentData.length; i++) {
                    csvContent += currentData[i].map(cell => {
                        // Escape cells that contain commas
                        if (typeof cell === 'string' && cell.includes(',')) {
                            return `"${cell}"`;
                        }
                        return cell;
                    }).join(',') + '\n';
                }
                
                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'cdr_export.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show download confirmation
                statusText.textContent = "CSV export completed successfully";
                statusBar.style.backgroundColor = '#27ae60';
                setTimeout(() => {
                    statusBar.style.backgroundColor = '';
                }, 3000);
            }
            
            // Reset application
            function resetApp() {
                currentData = [cdrHeaders];
                files = [];
                currentPage = 1;
                rowsPerPage = 30;
                rowsPerPageSelect.value = '30';
                fileInput.value = '';
                folderInput.value = '';
                updateFileList();
                tableSection.style.display = 'none';
                statusBar.style.display = 'none';
                renderTable();
            }
        });
    </script>
</body>
</html>
